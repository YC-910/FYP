<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hospital Login & Signup</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #3bb2b8, #65d6a6);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        overflow: hidden;
    }

    body::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: url('https://cdn-icons-png.flaticon.com/512/2966/2966480.png') repeat;
        background-size: 120px;
        opacity: 0.04;
        animation: heartbeat 2s infinite;
        pointer-events: none;
    }

    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .container {
        position: relative;
        width: 450px;
        background: rgba(255, 255, 255, 0.25);
        padding: 40px 30px;
        border-radius: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(12px);
        text-align: center;
        color: black;
    }

    .tab {
        cursor: pointer;
        padding: 14px 28px;
        display: inline-block;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px 10px 0 0;
        margin: 0 5px;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 18px;
    }

    .tab.active {
        background: #0f9d9a;
        color: #fff;
        transform: scale(1.1);
    }

    h2 {
        font-size: 28px;
        margin-bottom: 20px;
    }

    form {
        animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    input, select {
        width: 95%;
        padding: 14px;
        margin: 12px 0;
        border: none;
        border-radius: 10px;
        outline: none;
        font-size: 16px;
        color: #333;
    }

    select {
        background: white;
    }

    button {
        padding: 15px;
        width: 100%;
        background: #0f9d9a;
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    button:hover:enabled {
        background: #0d7a78;
        transform: translateY(-2px);
    }

    button:disabled {
        background: #999;
        cursor: not-allowed;
    }

    .captcha-box {
        margin: 15px 0;
        background: rgba(255, 255, 255, 0.4);
        padding: 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        color: #000;
        font-size: 16px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 350px;
        text-align: center;
        color: black;
        animation: slideUp 0.3s ease;
        font-size: 18px;
    }

    @keyframes fadeIn {
        from { opacity: 0; } to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    #signup-message {
        display: none;
        margin: 10px 0;
        padding: 10px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 15px;
        text-align: center;
    }
</style>
</head>
<body>

<div class="container">
    <div>
        <span class="tab" id="signup-tab">üè• Signup</span>
        <span class="tab active" id="login-tab">üîë Login</span>
    </div>

    <!-- Signup Form -->
    <form id="signup-form" style="display:none;">
        <h2>üë®‚Äç‚öïÔ∏è Signup</h2>
        <input type="text" id="signup-username" placeholder="Username" required>
        <input type="password" id="signup-password" placeholder="Password" required>
        <!-- <input type="password" id="signup-password" placeholder="Confirm Password" required>
        <input type="email" id="signup-email" placeholder="Workspace Email" required>
        <input type="number" id="signup-phone" placeholder="Workspace Phone" required>
        <input type="text" id="signup-hospitalname" placeholder="Hospital Name" required> -->
        <input type="text" id="signup-hospitalist" placeholder="Hospitalist ID (D12345 or N12345)" required>
        <select id="signup-role" required>
            <option value="">-- Select Role --</option>
            <option value="Doctor">Doctor</option>
            <option value="Nurse">Nurse</option>
        </select>
        <div class="captcha-box" id="signup-captcha">‚òë I am not a robot</div>
        <!-- Add this inside your signup form (before the button) -->
        <div id="signup-message" style="
            display:none;
            background: rgba(255, 0, 0, 0.2);
            color: darkred;
            padding: 8px;
            margin: 8px 0;
            border-radius: 6px;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        "></div>
        <div style="display: flex; justify-content: space-between; gap: 10px;">
            <button type="submit" id="signup-btn" disabled style="flex: 1;">Signup</button>
            <button type="button" onclick="window.location.href='/Welcome'" style="
                flex: 1;
                background: #ccc;
                color: #333;
                border: none;
                border-radius: 10px;
                font-weight: 600;
                font-size: 18px;
                cursor: pointer;
                transition: all 0.3s ease;
            ">Back</button>
        </div>
    </form>

    <!-- Login Form -->
    <form id="login-form">
        <h2>üîí Login</h2>
        <input type="text" id="login-username" placeholder="Username" required>
        <input type="password" id="login-password" placeholder="Password" required>
        <div class="captcha-box" id="login-captcha">‚òë I am not a robot</div>
        <div style="display: flex; justify-content: space-between; gap: 10px;">
        <button type="submit" id="login-btn" disabled style="flex: 1;">Login</button>
        <button type="button" onclick="window.location.href='/Welcome'" style="
            flex: 1;
            background: #ccc;
            color: #333;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        ">Back</button>
    </div>

    </form>
</div>

<!-- Modal for CAPTCHA Test -->
<div class="modal" id="captcha-modal">
    <div class="modal-content">
        <h3>Prove you're human</h3>
        <p id="captcha-question"></p>
        <input type="text" id="captcha-answer" placeholder="Your answer">
        <br><br>
        <button id="captcha-submit">Submit</button>
    </div>
</div>

<script>
    let currentCaptchaTarget = null;
    let captchaData = generateQuestion();
    let captchaGeneratedAt = Date.now();
    const CAPTCHA_VALIDITY_MS = 5 * 60 * 1000; // 5 minutes

    function generateQuestion() {
        let a = Math.floor(Math.random() * 10) + 1;
        let b = Math.floor(Math.random() * 10) + 1;
        return { question: `What is ${a} + ${b}?`, answer: (a + b).toString() };
    }

    function maybeRegenerateCaptcha(force = false) {
        let now = Date.now();
        if (force || now - captchaGeneratedAt > CAPTCHA_VALIDITY_MS) {
            captchaData = generateQuestion();
            captchaGeneratedAt = now;
        }
    }

    function openCaptcha(targetBtn) {
        currentCaptchaTarget = targetBtn;
        maybeRegenerateCaptcha();
        document.getElementById("captcha-question").innerText = captchaData.question;
        document.getElementById("captcha-answer").value = "";
        document.getElementById("captcha-modal").style.display = "flex";
    }

    document.getElementById("login-captcha").onclick = () => openCaptcha("login-btn");
    document.getElementById("signup-captcha").onclick = () => openCaptcha("signup-btn");

    document.getElementById("captcha-submit").onclick = function() {
        let answer = document.getElementById("captcha-answer").value.trim();
        if (answer === captchaData.answer) {
            document.getElementById(currentCaptchaTarget).disabled = false;
            document.getElementById("captcha-modal").style.display = "none";
            showPopupMessage("‚úÖ CAPTCHA passed!", "success");
        } else {
            showPopupMessage("‚ùå Wrong CAPTCHA answer!", "error");
            maybeRegenerateCaptcha(true);
        }
    };

    document.getElementById("captcha-modal").onclick = function(e) {
        if (e.target === this) {
            this.style.display = "none";
        }
    };

    document.getElementById("login-tab").onclick = function() {
        document.getElementById("login-form").style.display = "block";
        document.getElementById("signup-form").style.display = "none";
        this.classList.add("active");
        document.getElementById("signup-tab").classList.remove("active");
    };
    document.getElementById("signup-tab").onclick = function() {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("signup-form").style.display = "block";
        this.classList.add("active");
        document.getElementById("login-tab").classList.remove("active");
    };

    function showPopupMessage(message, type) {
        let msgBox = document.getElementById("signup-message");
        msgBox.innerText = message;
        msgBox.style.display = "block";
        msgBox.style.padding = "10px";
        msgBox.style.borderRadius = "5px";

        if (type === "error") {
            msgBox.style.background = "rgba(255, 0, 0, 0.2)";
            msgBox.style.color = "darkred";
        } else if (type === "success") {
            msgBox.style.background = "rgba(0, 128, 0, 0.2)";
            msgBox.style.color = "darkgreen";
        }
    }

    // ‚úÖ Signup (POST to Flask API)
    document.getElementById("signup-form").addEventListener("submit", async function(e) {
        e.preventDefault();

        let username = document.getElementById("signup-username").value.trim();
        let password = document.getElementById("signup-password").value.trim();
        let hospitalistId = document.getElementById("signup-hospitalist").value.trim();
        let role = document.getElementById("signup-role").value;

        let doctorPattern = /^D\d+$/i;
        let nursePattern = /^N\d+$/i;

        if (
            (role === "Doctor" && doctorPattern.test(hospitalistId)) ||
            (role === "Nurse" && nursePattern.test(hospitalistId))
        ) {
        try {
            let res = await fetch("/api/signup", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password, hospitalist_id: hospitalistId, role })
            });
            let data = await res.json();

            if (res.ok) {
            showPopupMessage(`‚úÖ Signup successful! Logging you in, ${role} ${username}...`, "success");

            // ‚úÖ Save role and username like login does
            localStorage.setItem("role", role);
            localStorage.setItem("username", username);

            // ‚úÖ Redirect based on role after short delay (so user sees success message)
            setTimeout(() => {
                if (role === "Doctor" || role === "Nurse") {
                    window.location.href = "/index";
                }
            }, 1000);
            } else {
                // üéØ Handle duplicate error messages from Flask
                if (data.error?.includes("username")) {
                    showPopupMessage("‚ùå Username duplicate, please type again.", "error");
                } 
                else if (data.error?.includes("hospitalist_id")) {
                    showPopupMessage("‚ùå Hospitalist ID duplicate, please type again.", "error");
                } 
                else {
                    showPopupMessage(`‚ùå ${data.error || "Signup failed"}`, "error");
                }
            }
        } catch (err) {
            showPopupMessage("‚ùå Server error during signup.", "error");
        }

        } else {
            showPopupMessage("‚ùå Signup failed: Please ensure role and Hospitalist ID match the rules.", "error");
        }
    });

    // ‚úÖ Login (POST to Flask API)
    document.getElementById("login-form").addEventListener("submit", async function(e) {
        e.preventDefault();

        let username = document.getElementById("login-username").value.trim();
        let password = document.getElementById("login-password").value.trim();

        try {
            let res = await fetch("/api/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });
            let data = await res.json();

    if (res.ok) {
        // Save role and username in localStorage
        localStorage.setItem("role", data.role);
        localStorage.setItem("username", data.username);

        // Redirect based on role
        if (data.role === "Doctor" || data.role === "Nurse") {
            window.location.href = "/index";
        }
    } else {
                showPopupMessage(`‚ùå ${data.error || "Login failed"}`, "error");
            }
        } catch (err) {
            showPopupMessage("‚ùå Server error during login.", "error");
        }
    });
</script>

</body>
</html>